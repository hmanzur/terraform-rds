name: ğŸ“¦ Terraform Environment Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: "ğŸ› ï¸ Action to perform"
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy

      environment:
        description: "ğŸŒ Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  bucket:
    name: ğŸ› ï¸ Create S3 bucket for Terraform state
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›  Checkout repo
        uses: actions/checkout@v4

      - name: ğŸªª Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: ğŸš€ Deploy CloudFormation stack
        run: |
          aws cloudformation deploy \
            --template-file create-tfstate-bucket.yml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides StateBucket=${{ vars.AWS_BUCKET_PREFIX }} Environment=${{ github.event.inputs.environment }} \
            --capabilities CAPABILITY_NAMED_IAM

  plan:
    name: ğŸ§ª Terraform Plan
    runs-on: ubuntu-latest
    needs: bucket

    outputs:
      plan-artifact: tfplan-${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’½ Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ§© Generate backend config from template
        run: |
          cat > backend.tfbackend <<EOF
          bucket         = "my-tfstate-${{ github.event.inputs.environment }}"
          key            = "${{ github.event.inputs.environment }}/terraform.tfstate"
          region         = "us-east-1"
          encrypt = true
          EOF

      - name: ğŸ“ Initialize Terraform
        run: terraform init -backend-config=backend.tfbackend

      - name: ğŸ“‹ Terraform plan
        run: terraform plan -out=tfplan -input=false

      - name: ğŸ“¦ Upload tfplan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: tfplan

  apply:
    name: ğŸš€ Terraform Apply (Approval Required)
    needs: plan
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’½ Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ§© Generate backend config from template
        run: |
          cat > backend.tfbackend <<EOF
          bucket         = "my-tfstate-${{ github.event.inputs.environment }}"
          key            = "${{ github.event.inputs.environment }}/terraform.tfstate"
          region         = "us-east-1"
          encrypt = true
          EOF

      - name: ğŸ“ Initialize Terraform
        run: terraform init -backend-config=backend.tfbackend

      - name: ğŸ“¦ Download tfplan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: .

      - name: ğŸ§¨ Terraform apply
        run: terraform apply tfplan
