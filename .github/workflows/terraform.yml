name: ğŸ“¦ Terraform

on:
  workflow_dispatch:
    inputs:
      action:
        description: "ğŸ› ï¸ Action to perform"
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy
          
      environment:
        description: "ğŸŒ Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  plan:
    name: ğŸ§ª Terraform Plan
    runs-on: ubuntu-latest

    outputs:
      plan-artifact: tfplan-${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’½ Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ“ Initialize Terraform
        run: terraform init

      - name: ğŸ“‹ Terraform plan
        run: terraform plan -out=tfplan -input=false

      - name: ğŸ“¦ Upload tfplan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: tfplan

  apply:
    name: ğŸš€ Terraform Apply (Approval Required)
    needs: plan
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’½ Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: ğŸ“ Initialize Terraform
        run: terraform init

      - name: ğŸ“¦ Download tfplan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment }}
          path: .

      - name: ğŸ§¨ Terraform apply
        run: terraform apply -auto-approve tfplan